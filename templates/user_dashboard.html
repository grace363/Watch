import React, { useState, useEffect } from 'react';
import { User, Play, Gift, Home, TrendingUp, Settings, LogOut, Menu, X, Video, Clock, DollarSign, Eye, AlertCircle } from 'lucide-react';

const UserDashboard = () => {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [user, setUser] = useState(null);
  const [videos, setVideos] = useState([]);
  const [alerts, setAlerts] = useState([]);
  const [onlineTime, setOnlineTime] = useState(0);
  const [isClaimingBonus, setIsClaimingBonus] = useState(false);
  const [loading, setLoading] = useState(true);
  const [sessionToken, setSessionToken] = useState(null);
  const [behavioralData, setBehavioralData] = useState({
    mouse_movements: 0,
    click_count: 0,
    keyboard_events: 0,
    focus_changes: 0,
    page_visibility_changes: 0
  });
  
  const MAX_VIDEOS_PER_DAY = 50;
  const DAILY_ONLINE_TIME = 3600; // 1 hour in seconds
  const DAILY_REWARD = 0.50;

  // Initialize component
  useEffect(() => {
    initializeDashboard();
    startBehavioralTracking();
    generateSessionToken();
  }, []);

  const generateSessionToken = () => {
    const token = Math.random().toString(36).substring(2) + Date.now().toString(36);
    setSessionToken(token);
  };

  const initializeDashboard = async () => {
    try {
      setLoading(true);
      await Promise.all([
        fetchUserData(),
        fetchVideos()
      ]);
    } catch (error) {
      showAlert('error', 'Failed to load dashboard data');
    } finally {
      setLoading(false);
    }
  };

  const fetchUserData = async () => {
    try {
      const response = await fetch('/api/user/profile', {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      if (!response.ok) {
        throw new Error('Failed to fetch user data');
      }

      const userData = await response.json();
      setUser(userData);
      setOnlineTime(userData.daily_online_time || 0);
    } catch (error) {
      console.error('Error fetching user data:', error);
      showAlert('error', 'Failed to load user data');
    }
  };

  const fetchVideos = async () => {
    try {
      const response = await fetch('/api/videos/available', {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      if (!response.ok) {
        throw new Error('Failed to fetch videos');
      }

      const videosData = await response.json();
      setVideos(videosData.videos || []);
    } catch (error) {
      console.error('Error fetching videos:', error);
      showAlert('error', 'Failed to load videos');
    }
  };

  // Behavioral tracking
  const startBehavioralTracking = () => {
    // Track mouse movements
    const handleMouseMove = () => {
      setBehavioralData(prev => ({
        ...prev,
        mouse_movements: prev.mouse_movements + 1
      }));
    };

    // Track clicks
    const handleClick = () => {
      setBehavioralData(prev => ({
        ...prev,
        click_count: prev.click_count + 1
      }));
    };

    // Track keyboard events
    const handleKeyPress = () => {
      setBehavioralData(prev => ({
        ...prev,
        keyboard_events: prev.keyboard_events + 1
      }));
    };

    // Track focus changes
    const handleFocusChange = () => {
      setBehavioralData(prev => ({
        ...prev,
        focus_changes: prev.focus_changes + 1
      }));
    };

    // Track page visibility changes
    const handleVisibilityChange = () => {
      setBehavioralData(prev => ({
        ...prev,
        page_visibility_changes: prev.page_visibility_changes + 1
      }));
    };

    // Add event listeners
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('click', handleClick);
    document.addEventListener('keypress', handleKeyPress);
    window.addEventListener('focus', handleFocusChange);
    window.addEventListener('blur', handleFocusChange);
    document.addEventListener('visibilitychange', handleVisibilityChange);

    // Cleanup function
    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('click', handleClick);
      document.removeEventListener('keypress', handleKeyPress);
      window.removeEventListener('focus', handleFocusChange);
      window.removeEventListener('blur', handleFocusChange);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  };

  // Heartbeat for daily session tracking
  useEffect(() => {
    const heartbeat = setInterval(() => {
      sendHeartbeat();
    }, 5000);

    return () => clearInterval(heartbeat);
  }, [sessionToken, behavioralData]);

  const sendHeartbeat = async () => {
    if (!sessionToken) return;

    try {
      const response = await fetch('/api/heartbeat', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          session_token: sessionToken,
          type: 'daily',
          focus_lost: behavioralData.focus_changes,
          back_button: false,
          behavioral_data: behavioralData,
          mouse_data: {
            movements: behavioralData.mouse_movements,
            clicks: behavioralData.click_count
          },
          screen_data: {
            width: window.screen.width,
            height: window.screen.height,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
          }
        })
      });

      if (response.ok) {
        const data = await response.json();
        setOnlineTime(data.online_time || 0);
      }
    } catch (error) {
      console.error('Heartbeat error:', error);
    }
  };

  const showAlert = (type, message) => {
    const alert = { id: Date.now(), type, message };
    setAlerts(prev => [...prev, alert]);
    setTimeout(() => {
      setAlerts(prev => prev.filter(a => a.id !== alert.id));
    }, 5000);
  };

  const claimDailyBonus = async () => {
    if (!user) return;

    if (onlineTime < DAILY_ONLINE_TIME) {
      showAlert('error', `You need ${DAILY_ONLINE_TIME - onlineTime} more seconds online to claim your bonus!`);
      return;
    }

    setIsClaimingBonus(true);
    
    try {
      const response = await fetch('/api/claim_daily_bonus', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          behavioral_data: behavioralData,
          device_data: {
            screen_width: window.screen.width,
            screen_height: window.screen.height,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            user_agent: navigator.userAgent,
            language: navigator.language
          }
        })
      });

      const data = await response.json();

      if (response.ok) {
        // Update user state with new data
        setUser(prev => ({
          ...prev,
          balance_usd: data.new_balance,
          daily_bonus_given: true,
          consecutive_days: data.consecutive_days,
          daily_online_time: 0
        }));
        
        setOnlineTime(0);
        
        showAlert('success', 
          `Daily bonus claimed! You earned $${data.bonus_amount.toFixed(2)} (Day ${data.consecutive_days})`
        );
      } else {
        showAlert('error', data.error || 'Failed to claim bonus');
      }
    } catch (error) {
      console.error('Error claiming bonus:', error);
      showAlert('error', 'Failed to claim bonus. Please try again.');
    } finally {
      setIsClaimingBonus(false);
    }
  };

  const watchVideo = async (videoId) => {
    if (!user) return;

    try {
      const response = await fetch('/api/watch_video', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          video_id: videoId,
          session_token: sessionToken
        })
      });

      const data = await response.json();

      if (response.ok) {
        showAlert('success', `Video session started! Watch for at least ${data.min_watch_time}s to earn $${data.reward_amount.toFixed(3)}`);
        // You could redirect to video player here
        // window.location.href = `/watch/${videoId}`;
      } else {
        showAlert('error', data.error || 'Failed to start video session');
      }
    } catch (error) {
      console.error('Error starting video:', error);
      showAlert('error', 'Failed to start video. Please try again.');
    }
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const progressPercent = Math.min((onlineTime / DAILY_ONLINE_TIME) * 100, 100);
  const can_watch_more = user ? user.videos_watched_today < MAX_VIDEOS_PER_DAY : false;

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-red-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Loading dashboard...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <AlertCircle size={64} className="text-red-500 mx-auto mb-4" />
          <h2 className="text-xl font-medium text-gray-900 mb-2">Unable to Load Dashboard</h2>
          <p className="text-gray-600 mb-4">Please try refreshing the page or contact support.</p>
          <button 
            onClick={initializeDashboard}
            className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Top Navigation */}
      <nav className="bg-white border-b border-gray-200 h-14 flex items-center justify-between px-4 sticky top-0 z-50">
        <div className="flex items-center gap-4">
          <button
            onClick={() => setSidebarOpen(!sidebarOpen)}
            className="p-2 rounded-full hover:bg-gray-100 transition-colors"
          >
            <Menu size={20} />
          </button>
          <div className="flex items-center gap-2 text-red-600 font-medium text-lg">
            <Play size={20} />
            Watch & Earn
          </div>
        </div>
        
        <div className="flex items-center gap-3 text-sm">
          <span className="text-gray-600 hidden sm:block">{user.email}</span>
          <div className="bg-green-600 text-white px-3 py-1 rounded-full font-medium">
            ${user.balance_usd.toFixed(2)}
          </div>
          <a href="/support" className="text-blue-600 hover:underline font-medium">
            Support
          </a>
        </div>
      </nav>

      {/* Sidebar */}
      <div className={`fixed top-14 left-0 w-72 h-full bg-white border-r border-gray-200 transform transition-transform duration-300 z-40 overflow-y-auto ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
        {/* Stats Section */}
        <div className="p-6 border-b border-gray-200">
          <div className="space-y-3">
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Videos Today</span>
              <span className="font-medium">{user.videos_watched_today}/{MAX_VIDEOS_PER_DAY}</span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Total Minutes</span>
              <span className="font-medium">{user.total_watch_minutes}</span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Daily Bonus</span>
              <span className="font-medium">{user.daily_bonus_given ? '✓ Claimed' : 'Available'}</span>
            </div>
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Account Type</span>
              <span className="font-medium">{user.account_type}</span>
            </div>
          </div>
        </div>

        {/* Navigation Links */}
        <div className="py-2">
          <div className="border-b border-gray-200 pb-2">
            <a href="/" className="flex items-center gap-6 px-6 py-3 text-sm hover:bg-gray-50 transition-colors">
              <Home size={16} />
              Home
            </a>
            <a href="/dashboard" className="flex items-center gap-6 px-6 py-3 text-sm hover:bg-gray-50 transition-colors">
              <TrendingUp size={16} />
              Dashboard
            </a>
          </div>
          
          <div className="border-b border-gray-200 py-2">
            <a href="/earnings" className="flex items-center gap-6 px-6 py-3 text-sm hover:bg-gray-50 transition-colors">
              <DollarSign size={16} />
              Earnings History
            </a>
            <a href="/profile" className="flex items-center gap-6 px-6 py-3 text-sm hover:bg-gray-50 transition-colors">
              <User size={16} />
              Profile Settings
            </a>
            <a href="/support" className="flex items-center gap-6 px-6 py-3 text-sm hover:bg-gray-50 transition-colors">
              <Settings size={16} />
              Support & Templates
            </a>
          </div>
          
          <div className="py-2">
            <a href="/logout" className="flex items-center gap-6 px-6 py-3 text-sm hover:bg-gray-50 transition-colors">
              <LogOut size={16} />
              Logout
            </a>
          </div>
        </div>
      </div>

      {/* Overlay */}
      {sidebarOpen && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden"
          onClick={() => setSidebarOpen(false)}
        />
      )}

      {/* Main Content */}
      <main className="max-w-6xl mx-auto p-6">
        {/* Flash Messages */}
        {alerts.map(alert => (
          <div key={alert.id} className={`mb-4 p-4 rounded-lg border-l-4 ${
            alert.type === 'error' ? 'bg-red-50 border-red-500 text-red-700' :
            alert.type === 'success' ? 'bg-green-50 border-green-500 text-green-700' :
            'bg-yellow-50 border-yellow-500 text-yellow-700'
          }`}>
            {alert.message}
          </div>
        ))}

        {/* Balance Display */}
        <div className="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-xl mb-6 text-center">
          <div className="text-3xl font-bold mb-2">${user.balance_usd.toFixed(2)}</div>
          <div className="text-green-100">Your Current Balance</div>
        </div>

        {/* Daily Bonus Section */}
        {!user.daily_bonus_given && (
          <div className="bg-gradient-to-r from-pink-500 to-teal-400 text-white p-6 rounded-xl mb-6 text-center">
            <h3 className="text-xl font-semibold mb-2">
              <Gift className="inline mr-2" size={20} />
              Daily Bonus Available!
            </h3>
            <p className="mb-4">Stay online and watch videos to earn your daily bonus</p>
            
            <div className="text-lg font-semibold mb-4">
              Time online: {formatTime(onlineTime)} / {formatTime(DAILY_ONLINE_TIME)}
            </div>
            
            <div className="bg-white bg-opacity-30 rounded-full h-2 mb-4 overflow-hidden">
              <div 
                className="bg-white h-full rounded-full transition-all duration-300"
                style={{ width: `${progressPercent}%` }}
              />
            </div>
            
            <button
              onClick={claimDailyBonus}
              disabled={onlineTime < DAILY_ONLINE_TIME || isClaimingBonus}
              className="bg-white bg-opacity-20 border-2 border-white text-white px-6 py-3 rounded-full font-semibold hover:bg-white hover:text-pink-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isClaimingBonus ? (
                'Claiming...'
              ) : (
                <>
                  <Gift className="inline mr-2" size={16} />
                  Claim ${DAILY_REWARD.toFixed(2)} Bonus
                </>
              )}
            </button>
          </div>
        )}

        {/* Videos Section */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-5">
            <h2 className="text-xl font-medium">Available Videos</h2>
            {!can_watch_more && (
              <span className="text-red-600 text-sm">Daily limit reached</span>
            )}
          </div>
          
          {videos.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
              {videos.map(video => (
                <div key={video.id} className="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-200 hover:-translate-y-1">
                  <div className="h-44 bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white relative">
                    <Play size={48} />
                    <div className="absolute bottom-2 right-2 bg-black bg-opacity-80 text-white px-2 py-1 rounded text-xs font-medium">
                      {video.min_watch_time}s
                    </div>
                  </div>
                  
                  <div className="p-4">
                    <h3 className="font-medium text-gray-900 mb-3 line-clamp-2 leading-tight">
                      {video.title}
                    </h3>
                    
                    <div className="flex items-center gap-4 text-sm text-gray-600 mb-3">
                      <span className="flex items-center gap-1">
                        <User size={14} />
                        User {video.added_by}
                      </span>
                      <span className="bg-green-600 text-white px-2 py-1 rounded text-xs font-medium">
                        ${video.reward_amount.toFixed(3)}
                      </span>
                    </div>
                    
                    {can_watch_more ? (
                      <button
                        onClick={() => watchVideo(video.id)}
                        className="w-full bg-red-600 text-white py-2.5 rounded-lg font-medium hover:bg-red-700 transition-colors"
                      >
                        <Play className="inline mr-2" size={16} />
                        Watch & Earn
                      </button>
                    ) : (
                      <button
                        disabled
                        className="w-full bg-gray-400 text-white py-2.5 rounded-lg font-medium cursor-not-allowed"
                      >
                        <AlertCircle className="inline mr-2" size={16} />
                        Daily Limit Reached
                      </button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-16 text-gray-500">
              <Video size={64} className="mx-auto mb-4 text-gray-300" />
              <h3 className="text-lg font-medium mb-2">No videos available</h3>
              <p>Check back later for new earning opportunities!</p>
            </div>
          )}
        </div>
      </main>
    </div>
  );
};

export default UserDashboard;
